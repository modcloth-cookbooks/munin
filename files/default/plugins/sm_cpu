#!/opt/local/bin/ruby193 -W0
#
# Copyright (C) Ben Marini
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#
# Magic markers (Used by munin-config and some installation scripts.
# Optional):
#%# family=auto
#%# capabilities=autoconf

class SmCpu
  def initialize
    @data = `/opt/local/bin/sm-cpuinfo -p`
  end

  def system
    number_value_for "cpu_util"
  end

  def zone
    number_value_for "cpu_used"
  end

  def number_value_for(label)
    @data[/#{label}:(.+)/, 1]
  end
end

case ARGV[0]
when 'autoconf'
  exit(0)
when 'config'
  puts 'graph_title Zone CPU usage'
  puts 'graph_order system zone idle'
  puts 'graph_category system'
  puts 'graph_args --base 1000 --lower-limit 0 --rigid --upper-limit 100'
  puts 'graph_vlabel %'
  puts 'graph_scale no'
  puts 'graph_period ${graph_period}'
  puts 'system.label system'
  puts 'system.draw AREA'
  puts 'system.type DERIVE'
  puts 'system.min 0'
  puts 'system.max 100'
  puts 'zone.label zone'
  puts 'zone.draw STACK'
  puts 'zone.type DERIVE'
  puts 'zone.min 0'
  puts 'zone.max 100'
  puts 'idle.label idle'
  puts 'idle.draw STACK'
  puts 'idle.type DERIVE'
  puts 'idle.min 0'
  puts 'idle.max 100'
  exit(0)
else
  cpu = SmCpu.new

  puts "system.value %s"  % cpu.system
  puts "zone.value %s"  % cpu.zone
  puts "idle.value 100"
end

__END__
cpu_used:1
cpu_util:0.1

